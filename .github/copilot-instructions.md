# Splitz – AI Coding Guide

- **Architecture**: Maven multi-module root [pom.xml](../pom.xml) with `user-service` (Spring Boot 3.2, Java 21) and placeholder `expense-service`. `expense-service` only has a stub main class; expect to scaffold a Spring Boot app before adding endpoints.
- **Planned scope**: See [IMPLEMENTATION_ROADMAP.md](../IMPLEMENTATION_ROADMAP.md) and [PROJECT_ANALYSIS_REPORT.md](../PROJECT_ANALYSIS_REPORT.md) for the intended Splitwise-like feature set, service boundaries, and phased delivery (REST + JWT now; gateway/gRPC later).
- **Build & run**: From repo root use `mvn clean install`. Run user service with `mvn -pl user-service spring-boot:run`. Java 21 is enforced by the parent POM; avoid downgrading. Tests are minimal; `mvn -pl user-service test` is the only meaningful target today.
- **Config & ports**: user service listens on 8080 using in-memory H2 with `create-drop` schema. Config lives in [user-service/src/main/resources/application.properties](../user-service/src/main/resources/application.properties). JWT secret/expiration are set here (base64 string); externalize for non-dev use.
- **Auth flow**: `/authenticate` issues JWTs via [user-service/src/main/java/com/splitz/user/security/AuthController.java](../user-service/src/main/java/com/splitz/user/security/AuthController.java) and [JwtUtil](../user-service/src/main/java/com/splitz/user/security/JwtUtil.java). Security chain is defined in [SecurityConfig](../user-service/src/main/java/com/splitz/user/config/SecurityConfig.java) with stateless JWT auth and role-based matchers: `/actuator/**` and `/public/**` are open, `/admin/**` is `ROLE_ADMIN`, `/editor/**` allows `ROLE_USER`/`ROLE_ADMIN`.
- **JWT filter**: Requests pass through [JwtRequestFilter](../user-service/src/main/java/com/splitz/user/security/JwtRequestFilter.java), which expects `Authorization: Bearer <token>` and loads users via `UserService`. Keep tokens compatible with `jjwt` 0.12 API and the configured HS256 key.
- **Domain & DTOs**: User model and roles sit in [user-service/src/main/java/com/splitz/user/model](../user-service/src/main/java/com/splitz/user/model). Mapping is via MapStruct [UserMapper](../user-service/src/main/java/com/splitz/user/mapper/UserMapper.java); it currently performs no password encoding—encode passwords in the mapper or service before save.
- **Known blockers**: In [User](../user-service/src/main/java/com/splitz/user/model/User.java) all account status methods return `false`, so authentication will always fail; set them to `true` (or real checks) before relying on login. Update/delete user endpoints are commented out in [UserController](../user-service/src/main/java/com/splitz/user/controller/UserController.java). Role initialization is missing; add a startup initializer to seed `ROLE_USER`/`ROLE_ADMIN`.
- **Repositories**: [UserRepository](../user-service/src/main/java/com/splitz/user/repository/UserRepository.java) uses `findByusername` (case-sensitive method name); reuse this exact method when querying. Roles use [RoleRepository](../user-service/src/main/java/com/splitz/user/repository/RoleRepository.java).
- **Endpoints (current)**: Public user CRUD under `/public/users` (create/list/get by id); login at `/authenticate`; roles exposed under `/public/role` for now. Harden/rename these when adding secured variants.
- **Error handling**: Global exception advice in [GlobalExceptionHandler](../user-service/src/main/java/com/splitz/user/exception/GlobalExceptionHandler.java) returns RFC 7807 `ProblemDetail` for `UserAlreadyExistsException`. Extend this pattern for new domain errors.
- **Data store**: Default H2 memory DB with `spring.jpa.hibernate.ddl-auto=create-drop`. PostgreSQL dependency exists but no prod profile—add `application-prod.properties` with `ddl-auto=validate` and migrations (Flyway/Liquibase) when ready.
- **Logging/monitoring**: Actuator health is enabled and whitelisted. No structured logging config yet; add Logback tweaks if you need request tracing.
- **Expense service start**: Before adding features, create a Spring Boot application class, dependencies (web, data-jpa, validation, jjwt/shared security), and `application.properties` mirroring the roadmap schemas. Keep user references by `userId`; call user-service for details.
- **Inter-service communication**: Roadmap favors REST for MVP and shared JWT validation. No clients exist—prefer RestTemplate/WebClient with proper timeouts and token forwarding.
- **Coding conventions**: Lombok is in use (`@Getter/@Setter`, etc.). MapStruct mapper uses `componentModel = "spring"`. Use constructor injection where possible (several classes still mix `@Autowired`). Maintain package layout per feature: config, controller, dto, exception, mapper, model, repository, security, service.
- **Default roles & seeds**: There is no data initializer; create one if you depend on roles for authorization checks. Ensure passwords are stored encoded (BCrypt configured in `SecurityConfig`).
- **Next safe fixes**: (1) flip account status flags, (2) encode passwords on create, (3) re-enable update/delete user endpoints with proper auth, (4) seed roles, (5) externalize JWT secret.
- **Running locally**: Typical flow — `mvn -pl user-service spring-boot:run`, hit `/authenticate` with existing seeded user (you need to create one via `/public/users` first), then call protected endpoints with returned JWT in `Authorization` header.
- **What not to break**: Parent POM manages dependency versions; do not hardcode versions in modules. Keep Spring Boot version aligned via the root property. Preserve stateless security and path-based authorization when adding endpoints.

If any section is unclear or you need more detail (e.g., expected expense-service entities or API contracts), tell me and I’ll refine these notes.
